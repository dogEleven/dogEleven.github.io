<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Void Chat | Smart Room</title>
    <style>
        :root {
            --bg-color: #0a0a0c;
            --sidebar-bg: #111114;
            --chat-bg: #16161a;
            --primary-color: #7f5af0;
            --primary-hover: #6641db;
            --text-color: #fffffe;
            --sub-text: #94a1b2;
            --input-bg: #242629;
            --message-self: #7f5af0;
            --message-other: #2cb67d;
            --message-host: #f1c40f;
            --system-msg: #94a1b2;
            --font-main: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }

        body {
            margin: 0;
            padding: 0;
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: var(--font-main);
            height: 100vh;
            height: 100dvh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* Glassmorphism Background Elements */
        .bg-orb {
            position: absolute;
            border-radius: 50%;
            filter: blur(80px);
            opacity: 0.15;
            z-index: -1;
            animation: float 20s infinite ease-in-out;
        }

        .orb-1 {
            width: 400px;
            height: 400px;
            background: var(--primary-color);
            top: -100px;
            left: -100px;
        }

        .orb-2 {
            width: 500px;
            height: 500px;
            background: var(--message-other);
            bottom: -150px;
            right: -150px;
            animation-delay: -10s;
        }

        @keyframes float {
            0% {
                transform: translate(0, 0);
            }

            50% {
                transform: translate(50px, 50px);
            }

            100% {
                transform: translate(0, 0);
            }
        }

        /* Header */
        header {
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(17, 17, 20, 0.6);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            z-index: 10;
        }

        .brand {
            font-size: 1.5rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .brand span {
            color: var(--primary-color);
        }

        .status-pill {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.85rem;
            background: var(--input-bg);
            padding: 0.25rem 0.75rem;
            border-radius: 999px;
            color: var(--sub-text);
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: #ef4565;
            box-shadow: 0 0 10px #ef4565;
            transition: background-color 0.3s, box-shadow 0.3s;
        }

        .status-dot.connected {
            background-color: #2cb67d;
            box-shadow: 0 0 10px #2cb67d;
        }

        .status-dot.host {
            background-color: #f1c40f;
            box-shadow: 0 0 10px #f1c40f;
        }

        /* Room Info Bar */
        .room-info {
            padding: 0.5rem 1rem;
            background: rgba(127, 90, 240, 0.1);
            border-bottom: 1px solid rgba(127, 90, 240, 0.1);
            text-align: center;
            font-size: 0.85rem;
            color: var(--primary-color);
        }

        /* Chat Window */
        main {
            flex: 1;
            display: flex;
            flex-direction: column;
            max-width: 1200px;
            width: 100%;
            margin: 0 auto;
            position: relative;
        }

        #chat-window {
            flex: 1;
            overflow-y: auto;
            padding: 2rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
            scroll-behavior: smooth;
        }

        #chat-window::-webkit-scrollbar {
            width: 6px;
        }

        #chat-window::-webkit-scrollbar-track {
            background: transparent;
        }

        #chat-window::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
        }

        /* Messages */
        .message-row {
            display: flex;
            gap: 1rem;
            animation: slideIn 0.3s ease-out;
            max-width: 80%;
        }

        .message-row.self {
            flex-direction: row-reverse;
            align-self: flex-end;
        }

        .message-row.system {
            align-self: center;
            max-width: 100%;
            justify-content: center;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: linear-gradient(135deg, #7f5af0, #2cb67d);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 0.9rem;
            color: white;
            flex-shrink: 0;
        }

        .msg-content {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .sender-name {
            font-size: 0.75rem;
            color: var(--sub-text);
        }

        .self .sender-name {
            text-align: right;
        }

        .bubble {
            padding: 0.75rem 1rem;
            border-radius: 12px;
            background: var(--input-bg);
            line-height: 1.5;
            word-wrap: break-word;
        }

        .self .bubble {
            background: var(--message-self);
            color: white;
            border-bottom-right-radius: 2px;
        }

        .other .bubble {
            background: var(--input-bg);
            border-bottom-left-radius: 2px;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .system .bubble {
            background: rgba(255, 255, 255, 0.05);
            color: var(--system-msg);
            font-size: 0.8rem;
            padding: 0.4rem 0.8rem;
            border-radius: 99px;
            border: none;
        }

        /* Input Area */
        .input-area {
            padding: 1.5rem;
            background: rgba(17, 17, 20, 0.8);
            backdrop-filter: blur(20px);
            border-top: 1px solid rgba(255, 255, 255, 0.05);
            z-index: 20;
        }

        .input-container {
            display: flex;
            gap: 1rem;
            max-width: 1200px;
            margin: 0 auto;
        }

        textarea {
            flex: 1;
            background: var(--input-bg);
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 1rem 3.5rem 1rem 1rem;
            color: white;
            font-family: var(--font-main);
            font-size: 1rem;
            resize: none;
            height: 24px;
            outline: none;
            overflow: hidden;
            line-height: 24px;
        }

        textarea:focus {
            border-color: var(--primary-color);
        }

        button.send-btn {
            position: absolute;
            right: 0.5rem;
            bottom: 0.5rem;
            width: 40px;
            height: 40px;
            border-radius: 8px;
            background: var(--primary-color);
            border: none;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        button.send-btn:hover {
            background: var(--primary-hover);
        }

        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            `;
            let myId=null;
            let isHost=false;
            let peer=null;
            let hostConnection=null; // Client -> Host connection
            const clientConnections=new Set(); // Host -> Clients connections

            const statusDot=document.getElementById('status-dot');
            const statusText=document.getElementById('status-text');
            const roomInfo=document.getElementById('room-info');
            const chatWindow=document.getElementById('chat-window');
            const emptyState=document.querySelector('.empty-state');

            // Robust STUN Config for Mobile/4G (Google + China mirrors)
            const peerConfig= {

                debug: 1,
                config: {
                    iceServers: [ {
                        urls: 'stun:stun.l.google.com:19302'
                    }

                    ,
                    {
                    urls: 'stun:stun1.l.google.com:19302'
                }

                ,
                // China-friendly public STUNs (Unverified but better than nothing)
                    {
                    urls: 'stun:stun.miwifi.com:3478'
                }

                ,
                {
                urls: 'stun:stun.qq.com:3478'
            }

            ]
        }
        }

        ;

        // --- Step 1: Attempt to be Host ---
        function init() {
            console.log("Attempting to claim Hostel ID:", HOST_ID);

            // Try to initialize as Host first
            const hostCandidate=new Peer(HOST_ID, peerConfig);

            hostCandidate.on('open', (id)=> {
                    // SUCCESS: We are the Host
                    console.log("I am the Host!");
                    isHost=true;
                    myId=id;
                    peer=hostCandidate;
                    setupHostLogic();
                });

            hostCandidate.on('error', (err)=> {
                    if (err.type==='unavailable-id') {
                        // FAILURE: Host ID is taken, so we become a Client
                        console.log("Host exists. Joining as Client...");
                        initClient();
                    }

                    else {
                        console.error("Peer Error:", err);
                        statusText.textContent="Error: " + err.type;
                    }
                });
        }

        // --- Host Logic ---
        function setupHostLogic() {
            statusDot.className='status-dot host';
            statusText.textContent='Host (Room Open)';
            roomInfo.textContent='You are the Host. Others will join you automatically.';
            emptyState.style.display='none';
            appendSystemMessage('Room created. Waiting for peers...');

            peer.on('connection', (conn)=> {
                    console.log("Client connected:", conn.peer);
                    clientConnections.add(conn);

                    conn.on('open', ()=> {
                            appendSystemMessage(`$ {
                                    conn.peer
                                }

                                joined the void.`);
                            // Send welcome message or history could go here
                        });

                    conn.on('data', (data)=> {
                            // Host received message from a client
                            // 1. Display locally
                            appendMessage(data.text, 'other', data.sender);

                            // 2. Broadcast to ALL OTHER clients (Star Topology Relay)
                            broadcastMessage(data, conn.peer);
                        });

                    conn.on('close', ()=> {
                            clientConnections.delete(conn);

                            appendSystemMessage(`$ {
                                    conn.peer
                                }

                                disconnected.`);
                        });
                });
        }

        function broadcastMessage(data, senderIdToExclude) {

            // Relay message to all clients except the sender
            for (let client of clientConnections) {
                if (client.peer !==senderIdToExclude && client.open) {
                    client.send(data);
                }
            }
        }

        // Retry State
        let retryCount=0;
        const maxRetries=5;

        // --- Client Logic ---
        function initClient() {
            // Generate random ID for client
            myId='User-'+Math.floor(Math.random() * 10000);
            peer=new Peer(myId, peerConfig);

            peer.on('open', (id)=> {
                    console.log("Client initialized:", id);
                    connectToHost();
                });

            peer.on('error', (err)=> console.error(err));
        }

        function connectToHost() {
            statusText.textContent='Connecting to Host...';

            hostConnection=peer.connect(HOST_ID);

            hostConnection.on('open', ()=> {
                    console.log("Connected to Host!");
                    statusDot.className='status-dot connected';
                    statusText.textContent='Connected to Room';

                    roomInfo.textContent=`Connected as $ {
                        myId
                    }

                    `;
                    emptyState.style.display='none';
                    appendSystemMessage('Successfully joined the room.');
                });

            hostConnection.on('data', (data)=> {
                    // Received message (relayed by Host or from Host)
                    appendMessage(data.text, 'other', data.sender);
                });

            hostConnection.on('close', ()=> {
                    statusDot.className='status-dot';
                    statusText.textContent='Disconnected';
                    appendSystemMessage('Lost connection to Host.');
                    attemptRetry();
                });

            hostConnection.on('error', (err)=> {
                    statusText.textContent='Host Unreachable';

                    // Don't spam system message on every retry fail, only on final fail
                    if (retryCount >=maxRetries) {
                        appendSystemMessage('Could not find the Host. Is anyone there?');
                    }

                    else {
                        attemptRetry();
                    }
                });
        }

        function attemptRetry() {
            if (retryCount < maxRetries) {
                retryCount++;
                const delay=2000; // 2 seconds

                statusText.textContent=`Retrying ($ {
                        retryCount
                    }

                    /$ {
                        maxRetries
                    })...`;
                setTimeout(connectToHost, delay);
            }

            else {
                statusText.textContent="Connection Failed";
                appendSystemMessage("Failed to connect after multiple attempts. Try refreshing.");
            }
        }

        // --- UI & Message Handling ---
        function appendMessage(text, type, senderName) {
            const row=document.createElement('div');

            row.className=`message-row $ {
                type
            }

            `;

            // Avatar
            const avatar=document.createElement('div');
            avatar.className='avatar';
            avatar.textContent=(senderName || '?').charAt(0).toUpperCase();

            // Avatar Color
            let hash=0;
            const str=senderName || 'User';
            for (let i=0; i < str.length; i++) hash=str.charCodeAt(i)+((hash << 5) - hash);

            const c1=`hsl($ {
                    hash % 360
                }

                , 70%, 60%)`;

            const c2=`hsl($ {
                    (hash + 40) % 360
                }

                , 70%, 50%)`;

            avatar.style.background=`linear-gradient(135deg, $ {
                    c1
                }

                , $ {
                    c2
                })`;

            const content=document.createElement('div');
            content.className='msg-content';

            const nameLabel=document.createElement('div');
            nameLabel.className='sender-name';
            nameLabel.textContent=senderName+(type==='self' ? ' (You)' : '');

            const bubble=document.createElement('div');
            bubble.className='bubble';
            bubble.textContent=text;

            content.appendChild(nameLabel);
            content.appendChild(bubble);

            row.appendChild(avatar);
            row.appendChild(content);

            chatWindow.appendChild(row);
            chatWindow.scrollTop=chatWindow.scrollHeight;
        }

        function appendSystemMessage(text) {
            const row=document.createElement('div');
            row.className='message-row system';
            const bubble=document.createElement('div');
            bubble.className='bubble';
            bubble.textContent=text;
            row.appendChild(bubble);
            chatWindow.appendChild(row);
            chatWindow.scrollTop=chatWindow.scrollHeight;
        }

        // --- Send Logic ---
        document.getElementById('chat-form').addEventListener('submit', (e)=> {
                e.preventDefault();
                const input=document.getElementById('message-input');
                const text=input.value.trim();
                if ( !text) return;

                const msgData= {
                    sender: myId, text: text
                }

                ;

                if (isHost) {
                    // I am Host: Show locally and broadcast to all
                    appendMessage(text, 'self', myId);
                    broadcastMessage(msgData, myId);
                }

                else {

                    // I am Client: Send to Host (who will relay)
                    if (hostConnection && hostConnection.open) {
                        hostConnection.send(msgData);
                        appendMessage(text, 'self', myId);
                    }

                    else {
                        alert("Not connected to the room!");
                    }
                }

                input.value='';
                input.style.height='auto';
            });

        // Auto-expand textarea
        const tx=document.getElementById('message-input');

        tx.addEventListener('input', function () {
                this.style.height='auto';
                this.style.height=(this.scrollHeight) + 'px';
            });

        tx.addEventListener('keydown', (e)=> {
                if (e.key==='Enter' && !e.shiftKey) {
                    e.preventDefault();
                    document.getElementById('chat-form').dispatchEvent(new Event('submit'));
                }

                peer.on('open', (id)=> {
                        console.log("Client initialized:", id);
                        connectToHost();
                    });

                peer.on('error', (err)=> console.error(err));
            }

            function connectToHost() {
                statusText.textContent='Connecting to Host...';

                hostConnection=peer.connect(HOST_ID);

                hostConnection.on('open', ()=> {
                        console.log("Connected to Host!");
                        statusDot.className='status-dot connected';
                        statusText.textContent='Connected to Room';

                        roomInfo.textContent=`Connected as $ {
                            myId
                        }

                        `;
                        emptyState.style.display='none';
                        appendSystemMessage('Successfully joined the room.');
                    });

                hostConnection.on('data', (data)=> {
                        // Received message (relayed by Host or from Host)
                        appendMessage(data.text, 'other', data.sender);
                    });

                hostConnection.on('close', ()=> {
                        statusDot.className='status-dot';
                        statusText.textContent='Disconnected';
                        appendSystemMessage('Lost connection to Host.');
                        attemptRetry();
                    });

                hostConnection.on('error', (err)=> {
                        statusText.textContent='Host Unreachable';

                        // Don't spam system message on every retry fail, only on final fail
                        if (retryCount >=maxRetries) {
                            appendSystemMessage('Could not find the Host. Is anyone there?');
                        }

                        else {
                            attemptRetry();
                        }
                    });
            }

            function attemptRetry() {
                if (retryCount < maxRetries) {
                    retryCount++;
                    const delay=2000; // 2 seconds

                    statusText.textContent=`Retrying ($ {
                            retryCount
                        }

                        /$ {
                            maxRetries
                        })...`;
                    setTimeout(connectToHost, delay);
                }

                else {
                    statusText.textContent="Connection Failed";
                    appendSystemMessage("Failed to connect after multiple attempts. Try refreshing.");
                }
            }

            // --- UI & Message Handling ---
            function appendMessage(text, type, senderName) {
                const row=document.createElement('div');

                row.className=`message-row $ {
                    type
                }

                `;

                // Avatar
                const avatar=document.createElement('div');
                avatar.className='avatar';
                avatar.textContent=(senderName || '?').charAt(0).toUpperCase();

                // Avatar Color
                let hash=0;
                const str=senderName || 'User';
                for (let i=0; i < str.length; i++) hash=str.charCodeAt(i)+((hash << 5) - hash);

                const c1=`hsl($ {
                        hash % 360
                    }

                    , 70%, 60%)`;

                const c2=`hsl($ {
                        (hash + 40) % 360
                    }

                    , 70%, 50%)`;

                avatar.style.background=`linear-gradient(135deg, $ {
                        c1
                    }

                    , $ {
                        c2
                    })`;

                const content=document.createElement('div');
                content.className='msg-content';

                const nameLabel=document.createElement('div');
                nameLabel.className='sender-name';
                nameLabel.textContent=senderName+(type==='self' ? ' (You)' : '');

                const bubble=document.createElement('div');
                bubble.className='bubble';
                bubble.textContent=text;

                content.appendChild(nameLabel);
                content.appendChild(bubble);

                row.appendChild(avatar);
                row.appendChild(content);

                chatWindow.appendChild(row);
                chatWindow.scrollTop=chatWindow.scrollHeight;
            }

            function appendSystemMessage(text) {
                const row=document.createElement('div');
                row.className='message-row system';
                const bubble=document.createElement('div');
                bubble.className='bubble';
                bubble.textContent=text;
                row.appendChild(bubble);
                chatWindow.appendChild(row);
                chatWindow.scrollTop=chatWindow.scrollHeight;
            }

            // --- Send Logic ---
            document.getElementById('chat-form').addEventListener('submit', (e)=> {
                    e.preventDefault();
                    const input=document.getElementById('message-input');
                    const text=input.value.trim();
                    if ( !text) return;

                    const msgData= {
                        sender: myId, text: text
                    }

                    ;

                    if (isHost) {
                        // I am Host: Show locally and broadcast to all
                        appendMessage(text, 'self', myId);
                        broadcastMessage(msgData, myId);
                    }

                    else {

                        // I am Client: Send to Host (who will relay)
                        if (hostConnection && hostConnection.open) {
                            hostConnection.send(msgData);
                            appendMessage(text, 'self', myId);
                        }

                        else {
                            alert("Not connected to the room!");
                        }
                    }

                    input.value='';
                    input.style.height='auto';
                });

            // Auto-expand textarea
            const tx=document.getElementById('message-input');

            tx.addEventListener('input', function () {
                    this.style.height='auto';
                    this.style.height=(this.scrollHeight) + 'px';
                });

            tx.addEventListener('keydown', (e)=> {
                    if (e.key==='Enter' && !e.shiftKey) {
                        e.preventDefault();
                        document.getElementById('chat-form').dispatchEvent(new Event('submit'));
                    }
                });

            // Start
            init();

            </script><div class="version-tag" >v4.1.0 (Mobile/4G Support)</div></body></html>