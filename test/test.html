<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TofuTodo</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <style>
        :root { --primary: #007aff; --bg: #f2f2f7; --card-bg: #ffffff; --text: #1c1c1e; --subtext: #8e8e93; }
        body { font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Helvetica Neue", sans-serif; background: var(--bg); padding: 20px; max-width: 600px; margin: 0 auto; color: var(--text); -webkit-font-smoothing: antialiased; }
        .login-box { background: var(--card-bg); padding: 30px; border-radius: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); text-align: center; margin-top: 50px; }
        input { width: 100%; box-sizing: border-box; padding: 12px 16px; margin: 15px 0; border: 1px solid #d1d1d6; border-radius: 10px; font-size: 16px; background: #f9f9f9; transition: all 0.2s; }
        input:focus { border-color: var(--primary); outline: none; background: white; }
        button { padding: 12px 24px; background: var(--primary); color: white; border: none; border-radius: 10px; cursor: pointer; font-size: 16px; font-weight: 600; transition: opacity 0.2s; width: 100%; }
        button:active { opacity: 0.8; }
        
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        h1 { font-size: 20px; font-weight: 700; margin: 0; }
        .logout-btn { background: none; color: var(--primary); font-weight: 400; padding: 4px 0; width: auto; font-size: 13px; }

        .new-task { background: var(--card-bg); padding: 10px; border-radius: 10px; margin-bottom: 16px; box-shadow: 0 2px 6px rgba(0,0,0,0.04); display: flex; flex-direction: column; gap: 8px; }
        .new-task-row { display: flex; gap: 10px; }
        .new-task input { margin: 0; border: none; background: transparent; padding: 0; font-size: 16px; }
        .new-task select { padding: 8px; border-radius: 8px; border: 1px solid #e5e5ea; background: #f2f2f7; font-size: 14px; color: var(--text); }
        .add-btn { width: auto; padding: 8px 16px; font-size: 14px; border-radius: 8px; }

        .todo-list { display: flex; flex-direction: column; gap: 12px; }
        .todo-item { background: var(--card-bg); padding: 8px 12px; border-radius: 8px; display: flex; align-items: flex-start; gap: 8px; box-shadow: 0 1px 2px rgba(0,0,0,0.03); margin-bottom: 6px; }
        .todo-item:active { transform: scale(0.99); background: #f9f9f9; }
        .todo-item.done { opacity: 0.5; }
        .todo-item.done .title { text-decoration: line-through; }
        
        /* Custom Checkbox */
        .checkbox { width: 16px; height: 16px; border-radius: 50%; border: 2px solid #c7c7cc; display: flex; align-items: center; justify-content: center; cursor: pointer; flex-shrink: 0; margin-top: 2px; }
        .todo-item.done .checkbox { background: var(--primary); border-color: var(--primary); }
        .checkbox::after { content: '‚úì'; color: white; font-size: 10px; display: none; }
        .todo-item.done .checkbox::after { display: block; }

        .content { flex-grow: 1; display: flex; flex-direction: row; align-items: flex-start; justify-content: space-between; gap: 8px; }
        .title { font-size: 13px; line-height: 1.3; word-break: break-word; flex-grow: 1; margin-right: 4px; }
        .labels { display: flex; flex-wrap: wrap; gap: 6px; }
        .label { font-size: 10px; padding: 2px 6px; border-radius: 4px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }
        
        /* Label Colors */
        .label-Work { background: #e0f2fe; color: #0284c7; }
        .label-Life { background: #dcfce7; color: #16a34a; }
        .label-HellDrop { background: #fee2e2; color: #dc2626; }
        .label-Zhutousan { background: #ffedd5; color: #ea580c; }
        
        .groups-container { display: flex; flex-direction: column; gap: 24px; }
        .group-section { }
        .group-title { font-size: 18px; font-weight: 700; margin: 0 0 12px 4px; display: flex; align-items: center; }
        .text-Work { color: #0284c7; }
        .text-Life { color: #16a34a; }
        .text-HellDrop { color: #dc2626; }
        .text-Zhutousan { color: #ea580c; }
        .text-Other { color: #64748b; }
    </style>
</head>
<body>
    <div id="app">
        <!-- Login View -->
        <div v-if="!token" class="login-box">
            <h1>üîê TofuTodo</h1>
            <p style="color:var(--subtext); margin-bottom: 20px;">Please enter your GitHub Personal Access Token (PAT).</p>
            <input v-model="inputToken" type="password" placeholder="ghp_..." style="text-align: center;">
            <button @click="saveToken" style="margin-top: 10px;">Access Dashboard</button>
        </div>

        <!-- Main View -->
        <div v-else>
            <div class="header">
                <h1>üìã ÂæÖÂäûÊ∏ÖÂçï</h1>
                <button @click="logout" class="logout-btn">Logout</button>
            </div>

            <div class="new-task">
                <div class="new-task-row">
                    <input v-model="newTask" placeholder="Add a new task..." @keyup.enter="addTask" style="flex-grow: 1;">
                </div>
                <div class="new-task-row" style="justify-content: space-between; align-items: center;">
                    <select v-model="newLabel">
                        <option value="Work">üíª Work</option>
                        <option value="Life">üßò‚Äç‚ôÇÔ∏è Life</option>
                        <option value="HellDrop">üéÆ HellDrop</option>
                        <option value="Zhutousan">üê∑ Zhutousan</option>
                    </select>
                    <button @click="addTask" class="add-btn">Add Task</button>
                </div>
            </div>

            <div v-if="loading" style="text-align: center; color: var(--subtext); padding: 20px;">Loading...</div>

            <div class="groups-container">
                <div v-for="(groupIssues, groupName) in groupedIssues" :key="groupName" class="group-section">
                    <h3 class="group-title" :class="'text-' + groupName">{{ groupName }} <span style="font-weight:400; color:var(--subtext); font-size:12px; margin-left:6px;">{{ groupIssues.length }}</span></h3>
                    <div class="todo-list">
                        <div v-for="issue in groupIssues" :key="issue.id" class="todo-item" :class="{done: issue.state === 'closed'}">
                            <div class="checkbox" @click="toggleIssue(issue)"></div>
                            <div class="content">
                                <div class="title">{{ issue.title }}</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const { createApp, ref, onMounted, computed } = Vue;
        const REPO = "dogEleven/tofutodo";

        createApp({
            setup() {
                const token = ref(localStorage.getItem('gh_token') || '');
                // ... (previous refs)
                const inputToken = ref('');
                const issues = ref([]);
                const loading = ref(false);
                const newTask = ref('');
                const newLabel = ref('Work');

                // ... (api setup)
                const api = axios.create({
                    baseURL: `https://api.github.com/repos/${REPO}`,
                    headers: { 'Accept': 'application/vnd.github.v3+json' }
                });

                const groupedIssues = computed(() => {
                    const groups = { 'Work': [], 'Life': [], 'HellDrop': [], 'Zhutousan': [], 'Other': [] };
                    
                    issues.value.forEach(issue => {
                        let placed = false;
                        if (issue.labels && issue.labels.length > 0) {
                            for (const label of issue.labels) {
                                if (groups[label.name]) {
                                    groups[label.name].push(issue);
                                    placed = true;
                                    break; // Only put in first matching group
                                }
                            }
                        }
                        if (!placed) groups['Other'].push(issue);
                    });
                    
                    // Remove empty groups if desired, or keep fixed order
                    return groups;
                });

                // ... (saveToken, logout, fetchIssues, toggleIssue, addTask methods remain same)
                const saveToken = () => {
                    if (!inputToken.value.startsWith('ghp_') && !inputToken.value.startsWith('github_pat_')) {
                        alert('Invalid Token format');
                        return;
                    }
                    localStorage.setItem('gh_token', inputToken.value);
                    token.value = inputToken.value;
                    fetchIssues();
                };

                const logout = () => {
                    localStorage.removeItem('gh_token');
                    token.value = '';
                    issues.value = [];
                };

                const fetchIssues = async () => {
                    if (!token.value) return;
                    loading.value = true;
                    try {
                        const res = await api.get('/issues?state=open&sort=created&direction=desc&per_page=100', {
                            headers: { 'Authorization': `token ${token.value}` }
                        });
                        issues.value = res.data;
                    } catch (e) {
                        alert('Failed to load issues: ' + e.message);
                        if (e.response && e.response.status === 401) logout();
                    } finally {
                        loading.value = false;
                    }
                };

                const toggleIssue = async (issue) => {
                    const newState = issue.state === 'open' ? 'closed' : 'open';
                    issue.state = newState;
                    try {
                        await api.patch(`/issues/${issue.number}`, { state: newState }, {
                            headers: { 'Authorization': `token ${token.value}` }
                        });
                        if (newState === 'closed') {
                            issues.value = issues.value.filter(i => i.id !== issue.id);
                        }
                    } catch (e) {
                        alert('Update failed');
                        issue.state = issue.state === 'open' ? 'closed' : 'open';
                    }
                };

                const addTask = async () => {
                    if (!newTask.value) return;
                    try {
                        const res = await api.post('/issues', {
                            title: newTask.value,
                            labels: [newLabel.value]
                        }, {
                            headers: { 'Authorization': `token ${token.value}` }
                        });
                        issues.value.unshift(res.data);
                        newTask.value = '';
                    } catch (e) {
                        alert('Failed to create task');
                    }
                };

                onMounted(() => {
                    if (token.value) fetchIssues();
                });

                return { token, inputToken, saveToken, logout, issues, loading, toggleIssue, newTask, newLabel, addTask, groupedIssues };
            }
        }).mount('#app');
    </script>
</body>
</html>