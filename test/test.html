<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TofuTodo</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <style>
        :root { 
            --primary: #007aff; 
            --bg: #f2f2f7; 
            --card-bg: #ffffff; 
            --text: #1c1c1e; 
            --subtext: #8e8e93; 
            --input-bg: #f9f9f9;
            --border: rgba(0,0,0,0.05);
        }
        [data-theme='dark'] {
            --bg: #1c1c1e;
            --card-bg: #2c2c2e;
            --text: #f2f2f7;
            --subtext: #8e8e93;
            --input-bg: #3a3a3c;
            --border: rgba(255,255,255,0.1);
        }
        body { font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Helvetica Neue", sans-serif; background: var(--bg); padding: 12px; max-width: 600px; margin: 0 auto; color: var(--text); -webkit-font-smoothing: antialiased; transition: background 0.3s, color 0.3s; }
        .login-box { background: var(--card-bg); padding: 30px; border-radius: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); text-align: center; margin-top: 50px; }
        input { width: 100%; box-sizing: border-box; padding: 12px 16px; margin: 15px 0; border: 1px solid #d1d1d6; border-radius: 10px; font-size: 16px; background: var(--input-bg); color: var(--text); transition: all 0.2s; }
        [data-theme='dark'] input { border-color: #3a3a3c; }
        input:focus { border-color: var(--primary); outline: none; background: var(--card-bg); }
        button { padding: 12px 24px; background: var(--primary); color: white; border: none; border-radius: 10px; cursor: pointer; font-size: 16px; font-weight: 600; transition: opacity 0.2s; width: 100%; }
        button:active { opacity: 0.8; }
        
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; margin-top: 4px; }
        .header-left { display: flex; align-items: center; gap: 10px; }
        h1 { font-size: 18px; font-weight: 700; margin: 0; }
        .theme-toggle { background: none; border: none; font-size: 20px; cursor: pointer; padding: 4px; width: auto; }
        .logout-btn { background: none; color: var(--primary); font-weight: 400; padding: 4px 0; width: auto; font-size: 13px; border: none; cursor: pointer; }

        .new-task { background: var(--card-bg); padding: 8px 10px; border-radius: 10px; margin-bottom: 12px; box-shadow: 0 1px 4px rgba(0,0,0,0.04); display: flex; flex-direction: column; gap: 8px; }
        .new-task-row { display: flex; gap: 8px; }
        .new-task input { margin: 0; border: none; background: transparent; padding: 0; font-size: 14px; }
        .new-task select { padding: 6px; border-radius: 6px; border: 1px solid #e5e5ea; background: var(--bg); font-size: 13px; color: var(--text); }
        [data-theme='dark'] .new-task select { border-color: #3a3a3c; }
        .add-btn { width: auto; padding: 6px 12px; font-size: 13px; border-radius: 6px; }

        .groups-container { display: flex; flex-direction: column; gap: 8px; }
        .group-title { font-size: 13px; font-weight: 700; margin: 0 0 4px 4px; display: flex; align-items: center; text-transform: uppercase; letter-spacing: 0.5px; opacity: 0.8; color: var(--subtext); }
        .group-title span { background: rgba(0,0,0,0.05); padding: 1px 6px; border-radius: 8px; font-size: 10px; margin-left: 6px; color: var(--text); font-weight: 600; }
        [data-theme='dark'] .group-title span { background: rgba(255,255,255,0.1); }
        
        .todo-list { display: flex; flex-direction: column; gap: 0; background: var(--card-bg); border-radius: 10px; overflow: hidden; box-shadow: 0 1px 3px rgba(0,0,0,0.04); }
        .todo-item { background: transparent; padding: 10px 12px; border-radius: 0; display: flex; align-items: flex-start; gap: 10px; margin-bottom: 0; border-bottom: 1px solid var(--border); }
        .todo-item:last-child { border-bottom: none; }
        .todo-item:active { background: var(--bg); }
        .todo-item.done { opacity: 0.5; }
        .todo-item.done .title { text-decoration: line-through; }
        
        /* Custom Checkbox */
        .checkbox { width: 16px; height: 16px; border-radius: 50%; border: 2px solid #c7c7cc; display: flex; align-items: center; justify-content: center; cursor: pointer; flex-shrink: 0; margin-top: 1px; }
        .todo-item.done .checkbox { background: var(--primary); border-color: var(--primary); }
        .checkbox::after { content: '‚úì'; color: white; font-size: 10px; display: none; }
        .todo-item.done .checkbox::after { display: block; }

        .content { flex-grow: 1; display: flex; flex-direction: row; align-items: flex-start; justify-content: space-between; gap: 8px; flex-wrap: nowrap; }
        .title { font-size: 13px; line-height: 1.3; word-break: break-word; flex-grow: 1; margin-right: 4px; color: var(--text); }
        
        /* Label Colors */
        .text-Work { color: #007aff; }
        .text-Life { color: #34c759; }
        .text-HellDrop { color: #ff3b30; }
        .text-Zhutousan { color: #ff9500; }
        .text-Other { color: var(--subtext); }

        .edit-input { flex-grow: 1; border: 1px solid var(--primary); border-radius: 4px; padding: 4px 8px; font-size: 13px; background: var(--input-bg); color: var(--text); margin: -4px 0; }
        .edit-actions { display: flex; gap: 8px; margin-left: 8px; font-size: 14px; cursor: pointer; }

        .title-container { flex-grow: 1; display: flex; flex-direction: column; gap: 2px; }
        .issue-meta { font-size: 10px; color: var(--subtext); transition: opacity 0.3s; }
    </style>
</head>
<body>
    <div id="app">
        <!-- Login View -->
        <div v-if="!token" class="login-box">
            <h1>üîê TofuTodo</h1>
            <p style="color:var(--subtext); margin-bottom: 20px;">Please enter your GitHub Personal Access Token (PAT).</p>
            <input v-model="inputToken" type="password" placeholder="ghp_..." style="text-align: center;">
            <button @click="saveToken" style="margin-top: 10px;">Access Dashboard</button>
        </div>

        <!-- Main View -->
        <div v-else>
            <div class="header">
                <div class="header-left">
                    <h1>üìã ÂæÖÂäûÊ∏ÖÂçï</h1>
                    <button @click="toggleTheme" class="theme-toggle">{{ isDark ? 'üåô' : '‚òÄÔ∏è' }}</button>
                </div>
                <button @click="logout" class="logout-btn">Logout</button>
            </div>

            <div class="new-task">
                <div class="new-task-row">
                    <input v-model="newTask" placeholder="Add a new task..." @keyup.enter="addTask" style="flex-grow: 1;">
                </div>
                <div class="new-task-row" style="justify-content: space-between; align-items: center;">
                    <select v-model="newLabel">
                        <option value="Work">üíª Work</option>
                        <option value="Life">üßò‚Äç‚ôÇÔ∏è Life</option>
                        <option value="HellDrop">üéÆ HellDrop</option>
                        <option value="Zhutousan">üê∑ Zhutousan</option>
                    </select>
                    <button @click="addTask" class="add-btn">Add Task</button>
                </div>
            </div>

            <div v-if="loading" style="text-align: center; color: var(--subtext); padding: 20px;">Loading...</div>

            <div class="groups-container">
                <div v-for="(groupIssues, groupName) in groupedIssues" :key="groupName" class="group-section">
                    <h3 class="group-title" :class="'text-' + groupName">{{ groupName }} <span style="font-weight:400; color:var(--subtext); font-size:12px; margin-left:6px;">{{ groupIssues.length }}</span></h3>
                    <div class="todo-list">
                        <div v-for="issue in groupIssues" :key="issue.id" class="todo-item" :class="{done: issue.state === 'closed'}">
                            <div class="checkbox" @click="toggleIssue(issue)"></div>
                            <div class="content">
                                <template v-if="editingIssueId === issue.id">
                                    <input v-model="editingTitle" @keyup.enter="saveEdit(issue)" @keyup.esc="cancelEdit" class="edit-input" ref="editInput">
                                    <div class="edit-actions">
                                        <span @click="saveEdit(issue)">‚úÖ</span>
                                        <span @click="cancelEdit">‚ùå</span>
                                    </div>
                                </template>
                                <template v-else>
                                    <div class="title-container" @click="startEdit(issue)">
                                        <div class="title">{{ issue.title }}</div>
                                        <div class="issue-meta" :style="{ opacity: getMetaOpacity(issue) }">
                                            Created: {{ formatDate(issue.created_at) }} | Updated: {{ formatDate(issue.updated_at) }}
                                        </div>
                                    </div>
                                </template>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const { createApp, ref, onMounted, computed, nextTick } = Vue;
        const REPO = "dogEleven/tofutodo";

        createApp({
            setup() {
                const token = ref(localStorage.getItem('gh_token') || '');
                const inputToken = ref('');
                const issues = ref([]);
                const loading = ref(false);
                const newTask = ref('');
                const newLabel = ref('Work');
                const editingIssueId = ref(null);
                const editingTitle = ref('');
                const editInput = ref(null);
                const isDark = ref(localStorage.getItem('theme') === 'dark');

                const api = axios.create({
                    baseURL: `https://api.github.com/repos/${REPO}`,
                    headers: { 'Accept': 'application/vnd.github.v3+json' }
                });

                const formatDate = (isoString) => {
                    const date = new Date(isoString);
                    return date.toLocaleString('zh-CN', { 
                        month: 'short', 
                        day: 'numeric', 
                        hour: '2-digit', 
                        minute: '2-digit' 
                    });
                };

                const getMetaOpacity = (issue) => {
                    const updated = new Date(issue.updated_at).getTime();
                    const now = new Date().getTime();
                    const diffMs = now - updated;
                    const diffDays = diffMs / (1000 * 60 * 60 * 24);
                    
                    // 24Â∞èÊó∂ÂÜÖ‰∏çÈÄèÊòéÂ∫¶ 0.8
                    // 7Â§©‰ª•‰∏ä‰∏çÈÄèÊòéÂ∫¶ 0.2
                    if (diffDays <= 1) return 0.8;
                    if (diffDays >= 7) return 0.2;
                    
                    // Á∫øÊÄßË°∞Âáè
                    return 0.8 - (diffDays - 1) * (0.6 / 6);
                };

                const groupedIssues = computed(() => {
                    const groups = { 'Work': [], 'Life': [], 'HellDrop': [], 'Zhutousan': [], 'Other': [] };
                    
                    issues.value.forEach(issue => {
                        let placed = false;
                        if (issue.labels && issue.labels.length > 0) {
                            for (const label of issue.labels) {
                                if (groups[label.name]) {
                                    groups[label.name].push(issue);
                                    placed = true;
                                    break; // Only put in first matching group
                                }
                            }
                        }
                        if (!placed) groups['Other'].push(issue);
                    });
                    
                    return groups;
                });

                const saveToken = () => {
                    if (!inputToken.value.startsWith('ghp_') && !inputToken.value.startsWith('github_pat_')) {
                        alert('Invalid Token format');
                        return;
                    }
                    localStorage.setItem('gh_token', inputToken.value);
                    token.value = inputToken.value;
                    fetchIssues();
                };

                const logout = () => {
                    localStorage.removeItem('gh_token');
                    token.value = '';
                    issues.value = [];
                };

                const fetchIssues = async () => {
                    if (!token.value) return;
                    loading.value = true;
                    try {
                        const res = await api.get('/issues?state=open&sort=created&direction=desc&per_page=100', {
                            headers: { 'Authorization': `token ${token.value}` }
                        });
                        issues.value = res.data;
                    } catch (e) {
                        alert('Failed to load issues: ' + e.message);
                        if (e.response && e.response.status === 401) logout();
                    } finally {
                        loading.value = false;
                    }
                };

                const toggleIssue = async (issue) => {
                    const newState = issue.state === 'open' ? 'closed' : 'open';
                    issue.state = newState;
                    try {
                        await api.patch(`/issues/${issue.number}`, { state: newState }, {
                            headers: { 'Authorization': `token ${token.value}` }
                        });
                        if (newState === 'closed') {
                            issues.value = issues.value.filter(i => i.id !== issue.id);
                        }
                    } catch (e) {
                        alert('Update failed');
                        issue.state = issue.state === 'open' ? 'closed' : 'open';
                    }
                };

                const addTask = async () => {
                    if (!newTask.value) return;
                    try {
                        const res = await api.post('/issues', {
                            title: newTask.value,
                            labels: [newLabel.value]
                        }, {
                            headers: { 'Authorization': `token ${token.value}` }
                        });
                        issues.value.unshift(res.data);
                        newTask.value = '';
                    } catch (e) {
                        alert('Failed to create task');
                    }
                };

                const startEdit = (issue) => {
                    if (issue.state === 'closed') return;
                    editingIssueId.value = issue.id;
                    editingTitle.value = issue.title;
                    nextTick(() => {
                        if (editInput.value && editInput.value[0]) {
                            editInput.value[0].focus();
                        }
                    });
                };

                const cancelEdit = () => {
                    editingIssueId.value = null;
                    editingTitle.value = '';
                };

                const saveEdit = async (issue) => {
                    if (!editingTitle.value || editingTitle.value === issue.title) {
                        cancelEdit();
                        return;
                    }
                    const oldTitle = issue.title;
                    issue.title = editingTitle.value;
                    try {
                        await api.patch(`/issues/${issue.number}`, { title: editingTitle.value }, {
                            headers: { 'Authorization': `token ${token.value}` }
                        });
                        cancelEdit();
                    } catch (e) {
                        alert('Update title failed');
                        issue.title = oldTitle;
                    }
                };

                const toggleTheme = () => {
                    isDark.value = !isDark.value;
                    const theme = isDark.value ? 'dark' : 'light';
                    document.documentElement.setAttribute('data-theme', theme);
                    localStorage.setItem('theme', theme);
                };

                onMounted(() => {
                    if (token.value) fetchIssues();
                    
                    // ÂàùÂßãÂåñ‰∏ªÈ¢ò
                    const savedTheme = localStorage.getItem('theme') || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
                    isDark.value = savedTheme === 'dark';
                    document.documentElement.setAttribute('data-theme', savedTheme);
                    
                    // ÊØèÊ¨°ÂõûÂà∞È°µÈù¢ÔºàÂèØËßÅÊÄßÊîπÂèò‰∏∫ÂèØËßÅÊó∂ÔºâËá™Âä®ÈáçÊñ∞ÊãâÂèñÊï∞ÊçÆ
                    document.addEventListener('visibilitychange', () => {
                        if (document.visibilityState === 'visible' && token.value) {
                            fetchIssues();
                        }
                    });
                });

                return { 
                    token, inputToken, saveToken, logout, issues, loading, toggleIssue, 
                    newTask, newLabel, addTask, groupedIssues,
                    editingIssueId, editingTitle, startEdit, cancelEdit, saveEdit, editInput,
                    isDark, toggleTheme, formatDate, getMetaOpacity
                };
            }
        }).mount('#app');
    </script>
</body>
</html>