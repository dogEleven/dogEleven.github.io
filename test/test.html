<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TofuTodo</title>
    <link rel="icon" type="image/png" href="favicon.png">
    
    <!-- PWA Setup -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="TofuTodo">
    <link rel="apple-touch-icon" href="https://github.com/dogEleven.png">

    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <!-- Markdown Parser -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <style>
        :root { 
            --primary: #4a90e2; /* Changed to Tofu Blue */
            --bg: #f5f5f7; 
            --card-bg: #ffffff; 
            --text: #1c1c1e; 
            --subtext: #8e8e93; 
            --input-bg: #f9f9f9;
            --border: rgba(0,0,0,0.05);
        }
        [data-theme='dark'] {
            --bg: #1c1c1e;
            --card-bg: #2c2c2e;
            --text: #f2f2f7;
            --subtext: #8e8e93;
            --input-bg: #3a3a3c;
            --border: rgba(255,255,255,0.1);
        }
        body { font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Helvetica Neue", sans-serif; background: var(--bg); padding: 12px; max-width: 600px; margin: 0 auto; color: var(--text); -webkit-font-smoothing: antialiased; transition: background 0.3s, color 0.3s; }
        .login-box { background: var(--card-bg); padding: 30px; border-radius: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); text-align: center; margin-top: 50px; }
        input, textarea { width: 100%; box-sizing: border-box; padding: 12px 16px; border: 1px solid #d1d1d6; border-radius: 10px; font-size: 16px; background: var(--input-bg); color: var(--text); transition: all 0.2s; font-family: inherit; }
        [data-theme='dark'] input, [data-theme='dark'] textarea { border-color: #3a3a3c; }
        input:focus, textarea:focus { border-color: var(--primary); outline: none; background: var(--card-bg); }
        button { padding: 12px 24px; background: var(--primary); color: white; border: none; border-radius: 10px; cursor: pointer; font-size: 16px; font-weight: 600; transition: opacity 0.2s; width: 100%; }
        button:active { opacity: 0.8; }
        
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; margin-top: 4px; }
        .header-left { display: flex; align-items: center; gap: 10px; }
        h1 { font-size: 18px; font-weight: 700; margin: 0; }
        .theme-toggle { background: none; border: none; font-size: 20px; cursor: pointer; padding: 4px; width: auto; }
        .logout-btn { background: none; color: var(--primary); font-weight: 400; padding: 4px 0; width: auto; font-size: 13px; border: none; cursor: pointer; }

        .tabs { display: flex; gap: 4px; background: rgba(0,0,0,0.05); padding: 4px; border-radius: 10px; margin-bottom: 12px; }
        [data-theme='dark'] .tabs { background: rgba(255,255,255,0.05); }
        .tab { flex: 1; text-align: center; padding: 6px; font-size: 13px; border-radius: 6px; cursor: pointer; color: var(--subtext); transition: all 0.2s; }
        .tab.active { background: var(--card-bg); color: var(--text); font-weight: 600; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }

        .new-task { background: var(--card-bg); padding: 8px 10px; border-radius: 10px; margin-bottom: 12px; box-shadow: 0 1px 4px rgba(0,0,0,0.04); display: flex; flex-direction: column; gap: 8px; }
        .new-task-row { display: flex; gap: 8px; }
        .new-task input { margin: 0; border: none; background: transparent; padding: 0; font-size: 14px; }
        .new-task select { padding: 6px; border-radius: 6px; border: 1px solid #e5e5ea; background: var(--bg); font-size: 13px; color: var(--text); }
        [data-theme='dark'] .new-task select { border-color: #3a3a3c; }
        .add-btn { width: auto; padding: 6px 12px; font-size: 13px; border-radius: 6px; }

        .groups-container { display: flex; flex-direction: column; gap: 8px; }
        .group-title { font-size: 13px; font-weight: 700; margin: 0 0 4px 4px; display: flex; align-items: center; text-transform: uppercase; letter-spacing: 0.5px; opacity: 0.8; color: var(--subtext); }
        .group-title span { background: rgba(0,0,0,0.05); padding: 1px 6px; border-radius: 8px; font-size: 10px; margin-left: 6px; color: var(--text); font-weight: 600; }
        [data-theme='dark'] .group-title span { background: rgba(255,255,255,0.1); }
        
        .todo-list { display: flex; flex-direction: column; gap: 0; background: var(--card-bg); border-radius: 10px; overflow: hidden; box-shadow: 0 1px 3px rgba(0,0,0,0.04); }
        .todo-item { background: transparent; padding: 10px 12px; border-radius: 0; display: flex; align-items: flex-start; gap: 10px; margin-bottom: 0; border-bottom: 1px solid var(--border); cursor: pointer; }
        .todo-item:last-child { border-bottom: none; }
        .todo-item:active { background: var(--bg); }
        .todo-item.done { opacity: 0.5; }
        .todo-item.done .title { text-decoration: line-through; }
        
        /* Custom Checkbox */
        .checkbox { width: 16px; height: 16px; border-radius: 50%; border: 2px solid #c7c7cc; display: flex; align-items: center; justify-content: center; cursor: pointer; flex-shrink: 0; margin-top: 1px; }
        .todo-item.done .checkbox { background: var(--primary); border-color: var(--primary); }
        .checkbox::after { content: '‚úì'; color: white; font-size: 10px; display: none; }
        .todo-item.done .checkbox::after { display: block; }

        .content { flex-grow: 1; display: flex; flex-direction: row; align-items: flex-start; justify-content: space-between; gap: 8px; flex-wrap: nowrap; }
        .title { font-size: 13px; line-height: 1.3; word-break: break-word; flex-grow: 1; margin-right: 4px; color: var(--text); }
        
        /* Label Colors */
        .text-Work { color: #007aff; }
        .text-Life { color: #34c759; }
        .text-HellDrop { color: #ff3b30; }
        .text-Zhutousan { color: #ff9500; }
        .text-Idea { color: #5856d6; }
        .text-Project { color: #af52de; }
        .text-Reference { color: #ff2d55; }
        .text-Other { color: var(--subtext); }

        .title-container { flex-grow: 1; display: flex; align-items: flex-start; justify-content: space-between; gap: 8px; }
        .issue-meta { font-size: 9px; color: var(--subtext); white-space: nowrap; margin-top: 2px; flex-shrink: 0; }

        /* Full Screen Editor Modal */
        .editor-modal {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: var(--bg); z-index: 1000;
            display: flex; flex-direction: column;
            transform: translateY(100%); transition: transform 0.3s ease;
        }
        .editor-modal.active { transform: translateY(0); }
        .editor-header {
            padding: 15px; border-bottom: 1px solid var(--border);
            display: flex; justify-content: space-between; align-items: center;
            background: rgba(var(--card-bg), 0.9);
        }
        .editor-body { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 15px; }
        .editor-title { font-size: 18px; font-weight: bold; border: none; background: transparent; outline: none; }
        .editor-textarea { flex: 1; border: none; background: transparent; resize: none; font-size: 16px; line-height: 1.6; outline: none; font-family: inherit; }
        .md-preview { display: none; padding: 10px 0; font-size: 16px; line-height: 1.6; }
        .md-preview.active { display: block; }
        .md-preview h1 { border-bottom: 1px solid var(--border); padding-bottom: 5px; }
        .md-preview img { max-width: 100%; border-radius: 8px; }
    </style>
</head>
<body>
    <div id="app">
        <!-- Login View -->
        <div v-if="!token" class="login-box">
            <h1>üîê TofuTodo</h1>
            <p style="color:var(--subtext); margin-bottom: 20px;">Please enter your GitHub Personal Access Token (PAT).</p>
            <input v-model="inputToken" type="password" placeholder="ghp_..." style="text-align: center;">
            <button @click="saveToken" style="margin-top: 10px;">Access Dashboard</button>
        </div>

        <!-- Main View -->
        <div v-else>
            <div class="header">
                <div class="header-left">
                    <h1>üìã ÂæÖÂäûÊ∏ÖÂçï</h1>
                    <button @click="toggleTheme" class="theme-toggle">{{ isDark ? 'üåô' : '‚òÄÔ∏è' }}</button>
                </div>
                <div style="display:flex; gap:10px;">
                    <button @click="showGroupModal = true" class="logout-btn" style="color:var(--text); font-weight:600;">
                        {{ currentTab === 'idea' ? '+ üìÅ' : '+ ÁªÑ' }}
                    </button>
                    <button @click="logout" class="logout-btn">Logout</button>
                </div>
            </div>

            <div class="tabs">
                <div class="tab" :class="{ active: currentTab === 'todo' }" @click="currentTab = 'todo'">üìã Ê∏ÖÂçï</div>
                <div class="tab" :class="{ active: currentTab === 'idea' }" @click="currentTab = 'idea'">üìù Â§áÂøòÂΩï</div>
            </div>

            <div class="new-task">
                <div class="new-task-row">
                    <input v-model="newTask" :placeholder="currentTab === 'todo' ? 'Add a new task...' : 'Type a memo...'" @keyup.enter="addTask" style="flex-grow: 1;">
                </div>
                <div class="new-task-row" style="justify-content: space-between; align-items: center;">
                    <select v-model="newLabel">
                        <template v-if="currentTab === 'todo'">
                            <option value="Work">üíª Work</option>
                            <option value="Life">üßò‚Äç‚ôÇÔ∏è Life</option>
                            <option value="HellDrop">üéÆ HellDrop</option>
                            <option value="Zhutousan">üê∑ Zhutousan</option>
                        </template>
                        <template v-else>
                            <option value="Idea">üí° Idea</option>
                            <option value="Project">üöÄ Project</option>
                            <option value="Reference">üìö Reference</option>
                        </template>
                    </select>
                    <button @click="addTask" class="add-btn">Add {{ currentTab === 'todo' ? 'Task' : 'Memo' }}</button>
                </div>
            </div>

            <div v-if="loading" style="text-align: center; color: var(--subtext); padding: 20px;">Loading...</div>

            <!-- Memo View (File Structure Style) -->
            <div v-if="currentTab === 'idea'" class="groups-container">
                <div v-for="(groupIssues, groupName) in filteredGroups" :key="groupName" class="group-section">
                    <h3 class="group-title" :class="'text-' + groupName">
                        üìÇ {{ groupName }} 
                        <span style="font-weight:400; color:var(--subtext); font-size:12px; margin-left:6px;">{{ groupIssues.length }}</span>
                    </h3>
                    <div class="todo-list">
                        <div v-for="issue in groupIssues" :key="issue.id" class="todo-item" @click="openEditor(issue)">
                            <div class="content" style="align-items: center;">
                                <span style="font-size:18px; margin-right:8px;">üìÑ</span>
                                <div class="title-container" style="flex-direction: column; gap:0;">
                                    <div class="title" style="font-weight:600; font-size:14px;">{{ issue.title }}</div>
                                    <div class="issue-meta" style="font-size:11px; margin-top:0;">
                                        {{ formatDate(issue.updated_at) }}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Todo View (Checkbox Style) -->
            <div v-else class="groups-container">
                <div v-for="(groupIssues, groupName) in filteredGroups" :key="groupName" class="group-section">
                    <h3 class="group-title" :class="'text-' + groupName">{{ groupName }} <span style="font-weight:400; color:var(--subtext); font-size:12px; margin-left:6px;">{{ groupIssues.length }}</span></h3>
                    <div class="todo-list">
                        <div v-for="issue in groupIssues" :key="issue.id" class="todo-item" :class="{done: issue.state === 'closed'}">
                            <div class="checkbox" @click.stop="toggleIssue(issue)"></div>
                            <div class="content" @click="openEditor(issue)">
                                <div class="title-container">
                                    <div class="title">{{ issue.title }}</div>
                                    <div class="issue-meta">
                                        <span :style="{ opacity: getMetaOpacity(issue.created_at) }">{{ formatDate(issue.created_at) }}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Markdown Editor Modal -->
        <div class="editor-modal" :class="{ active: isEditorOpen }">
            <div class="editor-header">
                <button class="logout-btn" @click="closeEditor">ÂèñÊ∂à</button>
                <div style="font-weight:600;">ÁºñËæë</div>
                <button class="logout-btn" style="font-weight:600;" @click="saveEditor">‰øùÂ≠ò</button>
            </div>
            <div class="editor-body">
                <input v-model="editingTitle" class="editor-title" placeholder="Ê†áÈ¢ò">
                <div style="display:flex; gap:10px; border-bottom: 1px solid var(--border); padding-bottom:5px;">
                    <button class="logout-btn" @click="showPreview = !showPreview">{{ showPreview ? '‚úèÔ∏è ÁºñËæë' : 'üëÅÔ∏è È¢ÑËßà' }}</button>
                </div>
                <textarea v-show="!showPreview" v-model="editingBody" class="editor-textarea" placeholder="ÊîØÊåÅ Markdown..."></textarea>
                <div v-show="showPreview" class="md-preview active" v-html="renderedMarkdown"></div>
            </div>
        </div>

    </div>

    <script>
        const { createApp, ref, onMounted, computed, nextTick, watch } = Vue;
        const REPO = "dogEleven/tofutodo";

        createApp({
            setup() {
                const token = ref(localStorage.getItem('gh_token') || '');
                const inputToken = ref('');
                const issues = ref([]);
                const loading = ref(false);
                const newTask = ref('');
                const newLabel = ref('Work');
                const isDark = ref(localStorage.getItem('theme') === 'dark');
                const currentTab = ref(localStorage.getItem('currentTab') || 'todo');

                // Editor State
                const isEditorOpen = ref(false);
                const editingIssue = ref(null);
                const editingTitle = ref('');
                const editingBody = ref('');
                const showPreview = ref(false);

                // Config
                const ignoredLabels = ['bug', 'documentation', 'duplicate', 'enhancement', 'good first issue', 'help wanted', 'invalid', 'question', 'wontfix'];

                watch(currentTab, (val) => {
                    localStorage.setItem('currentTab', val);
                    newLabel.value = val === 'todo' ? 'Work' : 'Idea';
                });

                const renderedMarkdown = computed(() => {
                    return editingBody.value ? marked.parse(editingBody.value) : '';
                });

                const api = axios.create({
                    baseURL: `https://api.github.com/repos/${REPO}`,
                    headers: { 'Accept': 'application/vnd.github.v3+json' }
                });

                const formatDate = (isoString) => {
                    const date = new Date(isoString);
                    const now = new Date();
                    const isThisYear = date.getFullYear() === now.getFullYear();
                    return isThisYear ? `${date.getMonth() + 1}/${date.getDate()}` : date.toLocaleDateString('zh-CN', { year: '2-digit', month: 'numeric', day: 'numeric' });
                };

                const getMetaOpacity = (isoString) => {
                    const diffDays = (new Date() - new Date(isoString)) / (1000 * 60 * 60 * 24);
                    return diffDays <= 1 ? 0.8 : (diffDays >= 7 ? 0.2 : 0.8 - (diffDays - 1) * 0.1);
                };

                const groupedIssues = computed(() => {
                    const groups = { 
                        'Work': [], 'Life': [], 'HellDrop': [], 'Zhutousan': [], 
                        'Idea': [], 'Project': [], 'Reference': [],
                        'Other': [] 
                    };
                    
                    issues.value.forEach(issue => {
                        let placed = false;
                        if (issue.labels && issue.labels.length > 0) {
                            for (const label of issue.labels) {
                                if (ignoredLabels.includes(label.name.toLowerCase())) continue;

                                if (groups[label.name]) {
                                    groups[label.name].push(issue);
                                    placed = true;
                                    break;
                                }
                            }
                        }
                        if (!placed) groups['Other'].push(issue);
                    });
                    return groups;
                });

                const filteredGroups = computed(() => {
                    const result = {};
                    const todoLabels = ['Work', 'Life', 'HellDrop', 'Zhutousan', 'Other'];
                    const ideaLabels = ['Idea', 'Project', 'Reference'];
                    
                    const targets = currentTab.value === 'todo' ? todoLabels : ideaLabels;
                    
                    targets.forEach(label => {
                        if (groupedIssues.value[label] && groupedIssues.value[label].length > 0) {
                            result[label] = groupedIssues.value[label];
                        }
                    });
                    return result;
                });

                // Editor Methods
                const openEditor = (issue) => {
                    if (issue.state === 'closed') return;
                    editingIssue.value = issue;
                    editingTitle.value = issue.title;
                    editingBody.value = issue.body || '';
                    showPreview.value = false;
                    isEditorOpen.value = true;
                };

                const closeEditor = () => {
                    isEditorOpen.value = false;
                    setTimeout(() => {
                        editingIssue.value = null;
                        editingTitle.value = '';
                        editingBody.value = '';
                    }, 300);
                };

                const saveEditor = async () => {
                    if (!editingTitle.value) return;
                    try {
                        const res = await api.patch(`/issues/${editingIssue.value.number}`, {
                            title: editingTitle.value,
                            body: editingBody.value
                        }, { headers: { 'Authorization': `token ${token.value}` } });
                        
                        // Update local list
                        const idx = issues.value.findIndex(i => i.id === editingIssue.value.id);
                        if (idx !== -1) issues.value[idx] = res.data;
                        
                        closeEditor();
                    } catch (e) {
                        alert('Save failed: ' + e.message);
                    }
                };

                const saveToken = () => {
                    if (!inputToken.value.startsWith('ghp_') && !inputToken.value.startsWith('github_pat_')) {
                        alert('Invalid Token format');
                        return;
                    }
                    localStorage.setItem('gh_token', inputToken.value);
                    token.value = inputToken.value;
                    fetchIssues();
                };

                const logout = () => {
                    localStorage.removeItem('gh_token');
                    token.value = '';
                    issues.value = [];
                };

                const fetchIssues = async () => {
                    if (!token.value) return;
                    loading.value = true;
                    try {
                        const res = await api.get('/issues?state=open&sort=created&direction=desc&per_page=100', {
                            headers: { 'Authorization': `token ${token.value}` }
                        });
                        issues.value = res.data;
                    } catch (e) {
                        alert('Failed to load issues: ' + e.message);
                        if (e.response && e.response.status === 401) logout();
                    } finally {
                        loading.value = false;
                    }
                };

                const toggleIssue = async (issue) => {
                    const newState = issue.state === 'open' ? 'closed' : 'open';
                    issue.state = newState;
                    try {
                        await api.patch(`/issues/${issue.number}`, { state: newState }, {
                            headers: { 'Authorization': `token ${token.value}` }
                        });
                        if (newState === 'closed') issues.value = issues.value.filter(i => i.id !== issue.id);
                    } catch (e) {
                        alert('Update failed');
                        issue.state = issue.state === 'open' ? 'closed' : 'open';
                    }
                };

                const addTask = async () => {
                    if (!newTask.value) return;
                    try {
                        const res = await api.post('/issues', {
                            title: newTask.value,
                            labels: [newLabel.value]
                        }, { headers: { 'Authorization': `token ${token.value}` } });
                        issues.value.unshift(res.data);
                        newTask.value = '';
                    } catch (e) { alert('Failed to create task'); }
                };

                const toggleTheme = () => {
                    isDark.value = !isDark.value;
                    const theme = isDark.value ? 'dark' : 'light';
                    document.documentElement.setAttribute('data-theme', theme);
                    localStorage.setItem('theme', theme);
                };

                onMounted(() => {
                    if (token.value) fetchIssues();
                    const savedTheme = localStorage.getItem('theme') || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
                    isDark.value = savedTheme === 'dark';
                    document.documentElement.setAttribute('data-theme', savedTheme);
                    document.addEventListener('visibilitychange', () => {
                        if (document.visibilityState === 'visible' && token.value) fetchIssues();
                    });
                });

                return { 
                    token, inputToken, saveToken, logout, issues, loading, toggleIssue, 
                    newTask, newLabel, addTask, groupedIssues, filteredGroups,
                    isDark, toggleTheme, formatDate, getMetaOpacity, currentTab,
                    // Editor
                    openEditor, closeEditor, saveEditor, isEditorOpen, editingTitle, editingBody, showPreview, renderedMarkdown
                };
            }
        }).mount('#app');
    </script>
</body>
</html>